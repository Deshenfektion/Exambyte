<!DOCTYPE html>
<html
  xmlns:th="http://www.thymeleaf.org"
  xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
>
  <!-- sec hinzugefügt, falls noch nicht da -->
  <head>
    <meta charset="UTF-8" />
    <title th:text="'Test: ' + ${test.title}">Test Ansicht</title>
    <!-- Dein CSS etc. -->
    <style>
      /* Optional: Etwas Abstand für die Optionen */
      .mc-option {
        margin-bottom: 5px;
        display: block; /* Sorgt dafür, dass jede Option auf einer neuen Zeile ist */
      }
      label {
        margin-left: 5px; /* Kleiner Abstand zwischen Checkbox/Radio und Text */
      }
    </style>
  </head>
  <body>
    <h1 th:text="${test.title}">Test Titel</h1>
    <p>
      Start:
      <span th:text="${#temporals.format(test.startTime, 'dd.MM.yyyy HH:mm')}"
        >Startzeit</span
      >
      | Ende:
      <span th:text="${#temporals.format(test.endTime, 'dd.MM.yyyy HH:mm')}"
        >Endzeit</span
      >
    </p>

    <div
      th:if="${isReadOnly}"
      style="
        color: orange;
        border: 1px solid orange;
        padding: 10px;
        margin-bottom: 15px;
      "
    >
      Dieser Test ist nicht mehr bearbeitbar (Endzeitpunkt erreicht oder noch
      nicht gestartet).
    </div>

    <!-- Anzeige von Erfolgs-/Fehlermeldungen -->
    <div
      th:if="${successMessage}"
      style="color: green"
      th:text="${successMessage}"
    ></div>
    <div
      th:if="${errorMessage}"
      style="color: red"
      th:text="${errorMessage}"
    ></div>

    <!-- Das Formular umschließt alle Fragen -->
    <!-- WICHTIG: Controller muss POST auf /student/tests/{id}/submit verarbeiten -->
    <form
      method="post"
      th:action="@{/student/tests/{id}/submit(id=${test.id})}"
    >
      <!-- CSRF Token -->
      <input
        type="hidden"
        th:name="${_csrf.parameterName}"
        th:value="${_csrf.token}"
      />

      <!-- Iteriere durch die Fragen des Tests -->
      <div
        th:each="question, iterStat : ${test.questions}"
        style="margin-bottom: 20px; border: 1px solid #ccc; padding: 15px"
      >
        <h3>
          Frage <span th:text="${iterStat.count}">1</span> (<span
            th:text="${question.maxPoints}"
            >P</span
          >
          Punkte)
        </h3>
        <!-- Frage anzeigen (erlaube HTML) -->
        <div th:utext="${question.questionText}">Fragentext...</div>
        <br />

        <!-- Antwortfeld basierend auf Fragentyp -->
        <div th:switch="${question.type}">
          <!-- Fall: Freitextfrage -->
          <div
            th:case="${T(de.hhu.exambyte.domain.model.QuestionType).FREETEXT}"
          >
            <label th:for="'q_freetext_' + ${question.id}">Deine Antwort:</label
            ><br />
            <!-- Name geändert, um Kollision mit MC zu vermeiden, falls beide gesendet werden -->
            <textarea
              th:id="'q_freetext_' + ${question.id}"
              rows="5"
              cols="80"
              th:name="'answersFreetext[' + ${question.id} + ']'"
              th:text="${submittedFreetextAnswers != null ? submittedFreetextAnswers.get(question.id) : ''}"
              th:disabled="${isReadOnly}"
            >
            </textarea>
          </div>

          <!-- Fall: Multiple Choice -->
          <div th:case="${T(de.hhu.exambyte.domain.model.QuestionType).MC}">
            <p>Wähle die richtige(n) Antwort(en):</p>
            <!-- Iteriere durch die Antwortoptionen der Frage -->
            <!-- Annahme: question hat ein Feld/Getter 'answerOptions' -->
            <!-- Annahme: Controller übergibt Map<Long, Set<Long>> selectedOptionIdsMap -->
            <div th:each="option : ${question.options}" class="mc-option">
              <input
                type="checkbox"
                th:id="'option_' + ${option.id}"
                th:name="'answersMC[' + ${question.id} + ']'"
                th:value="${option.id}"
                th:checked="${selectedOptionIdsMap != null and selectedOptionIdsMap.containsKey(question.id) and #lists.contains(selectedOptionIdsMap.get(question.id), option.id)}"
                th:disabled="${isReadOnly}"
              />
              <label
                th:for="'option_' + ${option.id}"
                th:utext="${option.optionText}"
                >Option Text</label
              >
            </div>
            <!-- Falls keine Optionen vorhanden sind (sollte nicht passieren, aber sicher ist sicher) -->
            <div th:if="${#lists.isEmpty(question.options)}">
              <p style="color: grey">
                (Keine Antwortoptionen für diese Frage verfügbar)
              </p>
            </div>
          </div>
        </div>
        <!-- Ende th:switch -->
      </div>
      <!-- Ende Frage-Div -->

      <!-- Senden-Button (nur aktiv, wenn Test bearbeitbar) -->
      <button type="submit" th:disabled="${isReadOnly}">
        Antworten speichern
      </button>
    </form>

    <hr />
    <a th:href="@{/student/dashboard}">Zurück zum Dashboard</a>
  </body>
</html>
